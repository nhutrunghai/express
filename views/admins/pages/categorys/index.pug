extends ../../layout/dashboard.pug
include ../../mixins/toast.pug
include ../../mixins/categorys.pug
include ../../mixins/categorys-tree.pug

block main
  style.
    .toolbar-sticky { position: sticky; top: 0; z-index: 101; }
    .table-sticky thead th { position: sticky; top: 0; background: #fff; }
    .k-actions button + button { margin-left: .25rem; }
    .slug-muted { font-size: .85rem; color: #6c757d; }

    /* ====== ANIMATION MƯỢT HƠN CHO PANE ====== */
    :root { --pane-speed: .9s; --pane-ease: cubic-bezier(.22,.61,.36,1); }
    .split { display: flex; gap: 1rem; }
    .pane {
      display: flex; flex-direction: column;
      flex: 1 1 50%; min-width: 0;
      transition:
        flex-basis var(--pane-speed) var(--pane-ease),
        max-width  var(--pane-speed) var(--pane-ease),
        width      var(--pane-speed) var(--pane-ease);
      will-change: flex-basis, max-width, width;
    }
    .pane.is-expanded   { flex: 1 1 100%; }
    .pane.is-collapsed  { flex: 0 0 76px; max-width: 76px; overflow: hidden; }
    .pane.is-collapsed .card-body { display: none; }
    .pane .pane-header-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .pane .card-header { padding: .5rem .75rem; }
    .pane .btn-expand { white-space: nowrap; }

    @media (prefers-reduced-motion: reduce) {
      .pane { transition: none !important; }
    }

    @media (max-width: 991.98px) {
      .split { flex-direction: column; }
      .pane, .pane.is-expanded, .pane.is-collapsed { flex: 1 1 auto; max-width: 100%; }
      .pane .card-body { display: block; }
    }

  .container.mt-4
    +Toast(messages)
    // == Toolbar trên cùng
    .card.border-0.shadow.toolbar-sticky.mb-3
      .card-body
        .d-flex.flex-wrap.align-items-center.justify-content-between.gap-2
          h2.h4.mb-0 Danh mục sản phẩm
          .d-flex.align-items-center.gap-2.flex-wrap
            .btn-group(role="group" aria-label="Bộ lọc trạng thái")
              button.btn.btn-outline-secondary(class=(currentStatus===''?'active':undefined) data-set="")
                i.fas.fa-layer-group.me-1
                | Tất cả
              button.btn.btn-outline-secondary(class=(currentStatus==='active'?'active':undefined) data-set="active")
                i.fas.fa-toggle-on.me-1
                | Hoạt động
              button.btn.btn-outline-secondary(class=(currentStatus==='inactive'?'active':undefined) data-set="inactive")
                i.fas.fa-toggle-off.me-1
                | Dừng hoạt động
        .mt-3
          .row.g-2
            .col-12.col-lg-6
              form(action="#", method="get", id="search-category")
                .input-group
                  span.input-group-text
                    i.fas.fa-search
                  input.form-control(type="text", placeholder="Tìm theo tên/slug", name="search", value= keySearch ? keySearch : "")
                  button.btn.btn-primary(type="submit")
                    i.fas.fa-magnifying-glass.me-1
                    | Tìm
            .col-12.col-lg-6.d-flex.justify-content-lg-end
              button.btn.btn-success#btn-open-create(type="button" data-bs-toggle="modal" data-bs-target="#modal-category")
                i.fas.fa-plus.me-1
                | Thêm danh mục

    // == Split layout
    .split
      // ==== Pane trái
      .pane.pane-left.is-collapsed(data-pane="left")
        .card.border-0.shadow-sm.h-100
          .card-header.bg-white.d-flex.align-items-center.justify-content-between
            span.pane-header-title
              i.fas.fa-sitemap.me-1
              | Cây danh mục
            button.btn.btn-sm.btn-outline-secondary.btn-expand(type="button" data-expand="left") Mở rộng
          .card-body
            if TreeCategotys && TreeCategotys.length
              +CategoryTree(TreeCategotys)    // truyền cây đã build (children[])
            else
              .text-muted Chưa có danh mục. Nhấn "Thêm danh mục" để tạo mới.

      // ==== Pane phải
      .pane.pane-right.is-expanded(data-pane="right")
        .card.border-0.shadow.h-100
          .card-header.bg-white.d-flex.align-items-center.justify-content-between
            span.pane-header-title
              i.fas.fa-table.me-1
              | Bảng danh mục
            button.btn.btn-sm.btn-outline-secondary.btn-expand(type="button" data-expand="right") Mở rộng
          .card-body
            // == Hàng công cụ ngang
            form(
              action=`/${pathAdmin}/categories/change-multi?_method=PATCH`
              method="POST"
              form-change-multi
              class="mb-3 border-0 shadow-sm card"
            )
              .card-body.d-flex.align-items-center.justify-content-between.flex-wrap.gap-2
                .d-flex.align-items-center.gap-2.flex-wrap
                  .form-group.mb-0
                    select(name="type" class="form-control")
                      option(disabled selected) -- Chọn hành động -- 
                      option(value="active") Hoạt động
                      option(value="inactive") Dừng hoạt động
                      option(value="delete-select") Xóa danh mục
                      option(value="changel-postion") Thay đổi vị trí
                  .form-group.mb-0
                    input(type="text", name="ids", value="" class="form-control" hidden)
                  button(type="submit" class="btn btn-primary") Áp dụng

                .d-flex.align-items-center.gap-2.flex-wrap.justify-content-lg-end
                  span.text-muted.small Sắp xếp:
                  .btn-group#sortGroup(role='group' aria-label='Sắp xếp nhanh')
                    button.btn.btn-outline-dark(type='button' data-sort='position') Vị Trí
                    button.btn.btn-outline-dark(type='button' data-sort='new') Mới Nhất
                    button.btn.btn-outline-dark(type='button' data-sort='quanity') Số Lượng
                  .dropdown
                    button#priceToggle.btn.btn-outline-dark.dropdown-toggle(type='button' data-bs-toggle='dropdown' aria-expanded='false') Giá
                    ul#priceMenu.dropdown-menu
                      li
                        button.dropdown-item(type='button' data-sort='price_asc') Giá: Thấp đến Cao
                      li
                        button.dropdown-item(type='button' data-sort='price_desc') Giá: Cao đến Thấp

            .table-responsive
              table.table.table-striped.table-hover.mb-0.table-sticky
                thead
                  tr
                    th(style="width:44px")
                      input(type="checkbox", name="checkall")
                    th STT
                    th Tên
                    th Slug
                    th Danh mục cha
                    th Vị trí
                    th Trạng thái
                    th Hành động
                tbody
                  - var __row = 0
                  - var __rowMap = {}
                  if categories && categories.length
                    +categoryRows(categories)
                  else
                    tr
                      td(colspan="8").text-center.text-muted Không có danh mục phù hợp.

    form(action="", method="POST", form-change, data-path=`/${pathAdmin}/categories/change-status`)
    //- form(action=`/${pathAdmin}/categories/delete`, method="POST", form-delete)


block script
  script(src="/admin/js/handle.change-multi.js")
  script(src="/admin/js/handle.change-single.js")
  script(src="/admin/js/handle.filter-status.js")
  script.
    (function(){
      const left  = document.querySelector('[data-pane="left"]');
      const right = document.querySelector('[data-pane="right"]');

      function expand(which){
        if(!left || !right) return;
        if(which === 'left'){
          left.classList.add('is-expanded');   left.classList.remove('is-collapsed');
          right.classList.add('is-collapsed'); right.classList.remove('is-expanded');
        }else{
          right.classList.add('is-expanded');  right.classList.remove('is-collapsed');
          left.classList.add('is-collapsed');  left.classList.remove('is-expanded');
        }
      }

      document.querySelectorAll('.btn-expand[data-expand]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const side = btn.getAttribute('data-expand');
          if(side === 'left') expand('left'); else expand('right');
        });
      });
    })();
